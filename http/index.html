<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">

<title>LED Lights!</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

<script type="text/javascript">
// Frame buster
if(top !== self) {
  top.location.replace(self.location.href);
}
</script>

<style type="text/css">
#videoContainer {
  position: absolute;
  top: 0;
  bottom: 0;
  left:     0;
  right: 0;
  z-index:  1;
}
#videoCanvas {
}
</style>
</head>

<body>
<!-- Code from iOS video devs -->

<div id="videoContainer"><canvas id="videoCanvas" width="160" height="120" /></div>

<!-- End code from iOS video devs -->

</body>

<!-- Code from iOS video devs -->

<script type="text/javascript" src="jsmpg.js"></script>
<script type="text/javascript">
// Show loading notice
var canvas = document.getElementById('videoCanvas');
var ctx = canvas.getContext('2d');
ctx.fillStyle = '#444';
ctx.fillText('Loading...', canvas.width/2-30, canvas.height/3);

// Setup the WebSocket connection and start the player (OpenShift moves websockets to port 8000)
if(location.host.search('.rhcloud.com') !== -1) {
  var client = new WebSocket('ws://' + location.hostname + ':' + 8000 + '/videoClient');
} else {
  var client = new WebSocket('ws://' + location.host + '/videoClient');
}
var player = new jsmpeg(client, {canvas:canvas});
</script>

<!-- End code from iOS video devs -->

<script type="text/javascript">

try {
  // OpenShift moves websockets to port 8000)
  if(location.host.search('.rhcloud.com') !== -1) {
    var webSocket = new WebSocket('ws://' + location.hostname + ':' + 8000 + '/controlClient');
  } else {
    var webSocket = new WebSocket('ws://' + location.host + '/controlClient');
  }
}
catch(error) {
  console.log("Websocket connection failed with error: " + error.message);
}

var rover = {}
rover.blank = [0, 0, 0, 0, 0, 0, 0, 0, 0];
rover.keyboard = rover.blank.slice();
rover.gamepad = rover.blank.slice();
rover.current = rover.blank.slice();
rover.previous = rover.blank.slice();
rover.message = {command: 'motors', motors: []};
rover.merge = function(a, b) {
  var result = rover.blank.slice();
  
  for(var i = 1, endi = 9; i < endi; ++i) {
    result[i] = a[i] || b[i] || 0;
  }
  
  return result;
}
rover.equals = function(a, b) {
  var result = true;
  
  for(var i = 1, endi = 9; i < endi; ++i) {
    if(a[i] !== b[i]) {
      result = false;
    }
  }
  
  return result;
}
rover.pushIfChanged = function() {
  rover.current = rover.merge(rover.keyboard, rover.gamepad);
  
  if(!rover.equals(rover.current, rover.previous)) {
    rover.message.motors = rover.current;
    webSocket.send(JSON.stringify(rover.message));
    
    rover.previous = rover.current.slice();
  }
}

// Keydown handlers need to be shuffled on and off the keydownHandlers objects because JS doesn't have an 'inital keydown only' event
var keysPressed     = [];
var keydownHandlers = {};
var keyupHandlers   = {};
var mObject         = {};

for(var i = 1, endi = 9; i < endi; ++i) with({i: i}) {
  keydownHandlers[48 + i] = function(e) {rover.keyboard[i] = e.type === 'keydown' ? 50 : 0} // 1-8 (keyboard)
}

for(var i in keydownHandlers) {
  keyupHandlers[i] = keydownHandlers[i];
}

document.addEventListener("keydown", function(e) {
  keysPressed[e.keyCode] = true;
  if(keydownHandlers[e.keyCode]) {
    keydownHandlers[e.keyCode](e);
    delete keydownHandlers[e.keyCode];
    rover.pushIfChanged();
  }
});

document.addEventListener("keyup", function(e) {
  delete keysPressed[e.keyCode];
  if(keyupHandlers[e.keyCode]) {
    keyupHandlers[e.keyCode](e);
    keydownHandlers[e.keyCode] = keyupHandlers[e.keyCode];
    rover.pushIfChanged();
  }
});

// This uses polling because gamepad events are not implemented anywhere at this time
var gamepadHandler = function() {
  var gamepads = navigator.getGamepads();
  
  if(gamepads[0]) {
    for(var i = 0, endi = 6; i < endi; ++i) {
      rover.gamepad[i + 1] = Math.floor(gamepads[0].axes[i]*255);
      
      rover.pushIfChanged();
    }
  }
}
setInterval(gamepadHandler, 100);

/////////////////////
// Startup scripts //
/////////////////////

eval(localStorage.onstart);

</script>
</html>
